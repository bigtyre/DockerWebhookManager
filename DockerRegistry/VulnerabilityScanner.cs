using DockerRegistry.Configuration;
using Flurl;
using TrivyAPIClient;

namespace DockerRegistryUI.Data;

public class VulnerabilityScanner(
        RegistrySettings settings,
        TrivyApiClient trivyApiClient
    )
{
    public async Task<TrivyScanResult> ScanAsync(string repositoryName, string tagName)
    {
        var imageUrl = GetImageUrl(repositoryName, tagName);
        var result = await trivyApiClient.GetScanResultAsync(imageUrl.ToString(), settings.Username, settings.Password);

       // await RecordScanResultAsync(result);

        return result;
    }

    private async Task RecordScanResultAsync(TrivyScanResult result)
    {
        throw new NotImplementedException();
    }

    public Uri GetImageUrl(string repositoryName, string tag)
    {
        var baseUrl = settings.Uri;
        return new(Url.Combine(baseUrl.ToString(), $"{repositoryName}:{tag}"));
    }
}
