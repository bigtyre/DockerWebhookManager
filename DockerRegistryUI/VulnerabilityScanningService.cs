
using DockerRegistryUI.Data;
using Org.BouncyCastle.Security;
using System.Threading;

namespace DockerRegistryUI
{
    public class VulnerabilityScanningService(
        ILogger<VulnerabilityScanningService> logger, 
        RegistryService registry, 
        VulnerabilityScanner vulnerabilityScanner
    ) : BackgroundService
    {
        private static readonly TimeSpan scanInterval = TimeSpan.FromHours(6);

        public VulnerabilityScanner VulnerabilityScanner { get; } = vulnerabilityScanner;

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            var cancellationToken = stoppingToken;

            logger.LogInformation($"{nameof(VulnerabilityScanningService)} started");
            try
            {
                logger.LogInformation($"Waiting 15 minutes before first vulnerability scan cycle");
                await Task.Delay(TimeSpan.FromMinutes(15), cancellationToken);

                while (!cancellationToken.IsCancellationRequested)
                {

                    logger.LogInformation($"Vulnerability scan cycle started");
                    try
                    {
                        await ScanAllRepositoriesForVulnerabilities(cancellationToken);
                    }
                    catch (Exception ex)
                    {
                        logger.LogError(ex, "Error in vulnerability scan cycle: {errorMessage}", ex.Message);

                    }
                    finally
                    {
                        logger.LogInformation($"Vulnerability scan cycle finished.");
                    }

                    await Task.Delay(scanInterval, cancellationToken);
                }
            }
            finally
            {
                logger.LogInformation($"{nameof(VulnerabilityScanningService)} stopped");
            }

        }

        private async Task ScanAllRepositoriesForVulnerabilities(CancellationToken cancellationToken)
        {
            var repositories = (await registry.GetRepositoriesAsync()).OrderBy(c => c.Name).ToList();

            var numRepositories = repositories.Count;

            logger.LogDebug("Scanning {numRepositories} repositor{pluralization} for vulnerabilities.", numRepositories, (numRepositories == 1 ? "y" : "ies"));
            int i = 0;
            foreach (var repository in repositories)
            {
                i++;
                var repositoryName = repository.Name;
                try
                {
                    logger.LogDebug("Scanning repository {repositoryName} for vulnerabilities ({i}/{numRepositories})", repositoryName, i, numRepositories);

                    await VulnerabilityScanner.ScanAsync(repositoryName, "latest");
                }
                catch (Exception ex)
                {
                    logger.LogError(ex, "Error while scanning repository {repositoryName} for vulnerabilities: {errorMessage}", repositoryName, ex.Message);
                }
            }
        }
    }
}
